<!DOCTYPE html>

<html>
<head>
  <title>boleto-service.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>boleto-service.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>Primeiro inicialize as rotas angular atraves
de templates. Para recuperar esses templates, precisamos
antes requerilos do servidor.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">fetchBoletoService</span> = -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>A mensagem de carregamento inicial
deve ser atualizada</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        loader = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'masterLoader'</span>)
        p = loader.children[<span class="hljs-number">9</span>]
        p.innerHTML = <span class="hljs-string">"Construindo serviços..."</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Serviço de boletos</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">        <span class="hljs-title">Service</span> = <span class="hljs-params">($http, $q, toastr)</span> -&gt;</span>

                BoletoService = {}</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Referencia um boleto a um token de um formulario</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">                <span class="hljs-title">create</span> = <span class="hljs-params">(uuid, token, data)</span> -&gt;</span>
                        $q (resolve, reject) -&gt;
                                url = []
                                url.push <span class="hljs-string">"<span class="hljs-subst">#{k}</span>=<span class="hljs-subst">#{v}</span>"</span> <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">of</span> data
                                url = <span class="hljs-string">'/paypal/invoices/novo?'</span>+url.join(<span class="hljs-string">'&amp;'</span>)
                                $http.post(url).<span class="hljs-keyword">then</span> (invoiceid)-&gt;
                                        BoletoService.status(invoiceid.data).<span class="hljs-keyword">then</span> (status) -&gt;
                                                db = firebase.database()
                                                db.ref(<span class="hljs-string">"boletos/<span class="hljs-subst">#{uuid}</span>"</span>).once <span class="hljs-string">'value'</span>, <span class="hljs-function"><span class="hljs-params">(boletos)</span> -&gt;</span>
                                                        <span class="hljs-keyword">if</span> boletos.val() <span class="hljs-keyword">isnt</span> <span class="hljs-literal">null</span>
                                                                bol = boletos.val()
                                                        <span class="hljs-keyword">else</span>
                                                                bol = []
                                                        bol.push({
                                                                token: token
                                                                invoice: invoiceid.data
                                                                status: status
                                                                email: data[<span class="hljs-string">'billing_info_email'</span>]
                                                        })
                                                        db.ref(<span class="hljs-string">"boletos/<span class="hljs-subst">#{uuid}</span>"</span>)
                                                                .set(bol)
                                                                .<span class="hljs-keyword">then</span>(<span class="hljs-function">-&gt;</span> resolve invoiceid.data)
                                                                .<span class="hljs-keyword">catch</span>(reject)
<span class="hljs-function">                                
                <span class="hljs-title">onErr</span>  = <span class="hljs-params">(err)</span> -&gt;</span>
                        toastr.error(err.code, err.message)
                        <span class="hljs-built_in">console</span>.error(err.code, err.message)</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Crie um novo boleto requisitando
a API do paypal (que está no backend)
e atualize os dados na base de dados</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                BoletoService.novo = <span class="hljs-function"><span class="hljs-params">(uuid, token, options)</span>-&gt;</span>
                        $q (resolve, reject) -&gt;
<span class="hljs-function">                                <span class="hljs-title">onCreate</span> = <span class="hljs-params">(result)</span> -&gt;</span> toastr.success(<span class="hljs-string">"Boleto"</span>, <span class="hljs-string">"boleto <span class="hljs-subst">#{result}</span> criado"</span>)
                                create(uuid, token, options).<span class="hljs-keyword">then</span>(onCreate).<span class="hljs-keyword">then</span>(resolve).<span class="hljs-keyword">catch</span> reject 


                BoletoService.status = <span class="hljs-function"><span class="hljs-params">(pid)</span> -&gt;</span>
                        $q (resolve, reject) -&gt;
                                $http.get(<span class="hljs-string">"/paypal/invoices/<span class="hljs-subst">#{pid}</span>/status"</span>).<span class="hljs-keyword">then</span>( <span class="hljs-function"><span class="hljs-params">(r)</span> -&gt;</span>
                                        resolve r.data
                                ).<span class="hljs-keyword">catch</span> (e) -&gt; toastr.error(e.code, e.message)</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Crie uma suíte de requisições para o paypal</p>
<ul>
<li>enviar uma notificação</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>                BoletoService.send = <span class="hljs-function"><span class="hljs-params">(token, pid)</span> -&gt;</span>
                        $q (resolve, reject) -&gt;
                                $http.post(<span class="hljs-string">"/paypal/invoices/<span class="hljs-subst">#{pid}</span>/send"</span>).<span class="hljs-keyword">then</span> (r) -&gt;
                                        BoletoService.status(pid).<span class="hljs-keyword">then</span> (status) -&gt;
                                                db = firebase.database()
                                                db.ref(<span class="hljs-string">"boletos/"</span>).once <span class="hljs-string">'value'</span>,<span class="hljs-function"><span class="hljs-params">(boletos)</span>-&gt;</span>
<span class="hljs-function">                                                        <span class="hljs-title">onSend</span> = -&gt;</span> toastr.info(<span class="hljs-string">"Email"</span>, r.data)
                                                        _boletos = boletos.val()
                                                        <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">of</span> _boletos
                                                                <span class="hljs-keyword">for</span> b <span class="hljs-keyword">in</span> v
                                                                        <span class="hljs-keyword">if</span> b.token <span class="hljs-keyword">is</span> token <span class="hljs-keyword">and</span> b.invoice <span class="hljs-keyword">is</span> pid <span class="hljs-keyword">and</span> b.status <span class="hljs-keyword">is</span> <span class="hljs-string">'DRAFT'</span>
                                                                                b.status = status
                                                                                
                                                        db.ref(<span class="hljs-string">"boletos/"</span>).set(_boletos).<span class="hljs-keyword">then</span>(onSend).<span class="hljs-keyword">then</span>(resolve).<span class="hljs-keyword">catch</span>(reject)

                BoletoService.remind = <span class="hljs-function"><span class="hljs-params">(token, pid)</span> -&gt;</span>
                        $q (resolve, reject) -&gt;
                                db = firebase.database()
                                db.ref(<span class="hljs-string">"boletos/"</span>).once <span class="hljs-string">'value'</span>, <span class="hljs-function"><span class="hljs-params">(boletos)</span> -&gt;</span>
<span class="hljs-function">                                        <span class="hljs-title">onRemind</span> = <span class="hljs-params">(r)</span> -&gt;</span>
                                                toastr.info(<span class="hljs-string">"Email"</span>, r.data)
                                                resolve()

                                        <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">of</span> boletos.val()
                                                <span class="hljs-keyword">for</span> b <span class="hljs-keyword">in</span> v
                                                        <span class="hljs-keyword">if</span> pid <span class="hljs-keyword">is</span> b.invoice
                                                                <span class="hljs-keyword">if</span> b.status <span class="hljs-keyword">is</span> <span class="hljs-string">'SENT'</span>
                                                                        b.status = <span class="hljs-string">'REMIND'</span>
                                                                        $http.post(<span class="hljs-string">"/paypal/invoices/<span class="hljs-subst">#{pid}</span>/remind"</span>).<span class="hljs-keyword">then</span>(onRemind).<span class="hljs-keyword">catch</span> (e) -&gt; toastr.error(e.code, e.message)

                BoletoService.cancel = <span class="hljs-function"><span class="hljs-params">(token, pid)</span> -&gt;</span>
                        $q (resolve, reject) -&gt;
                                $http.post(<span class="hljs-string">"/paypal/invoices/<span class="hljs-subst">#{pid}</span>/cancel"</span>).<span class="hljs-keyword">then</span>(<span class="hljs-function"><span class="hljs-params">(status)</span> -&gt;</span>
                                        db = firebase.database()
                                        BoletoService.status(pid).<span class="hljs-keyword">then</span> (status) -&gt;
                                                db.ref(<span class="hljs-string">"boletos/"</span>).once <span class="hljs-string">'value'</span>, <span class="hljs-function"><span class="hljs-params">(boletos)</span>-&gt;</span>
<span class="hljs-function">                                                        <span class="hljs-title">onSend</span> = -&gt;</span> toastr.info(<span class="hljs-string">"Email"</span>, status)
                                                        _boletos = boletos.val()
                                                        <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">of</span> _boletos
                                                                <span class="hljs-keyword">for</span> b <span class="hljs-keyword">in</span> v
                                                                        <span class="hljs-keyword">if</span> b.token <span class="hljs-keyword">is</span> token <span class="hljs-keyword">and</span> b.invoice <span class="hljs-keyword">is</span> pid <span class="hljs-keyword">then</span> b.status = status
                                                        db.ref(<span class="hljs-string">"boletos/"</span>).set(_boletos).<span class="hljs-keyword">then</span>(onSend).<span class="hljs-keyword">then</span>(resolve).<span class="hljs-keyword">catch</span>(reject)
                                ).<span class="hljs-keyword">catch</span> onErr

                Array.prototype.remove = <span class="hljs-function"><span class="hljs-params">(<span class="hljs-keyword">from</span>, to)</span> -&gt;</span>
                        rest = @slice((to <span class="hljs-keyword">or</span> <span class="hljs-keyword">from</span>) + <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> @length)
                        @length = <span class="hljs-keyword">if</span> <span class="hljs-keyword">from</span> &lt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> @length + <span class="hljs-keyword">from</span> <span class="hljs-keyword">else</span> <span class="hljs-keyword">from</span>;
                        @push.apply(<span class="hljs-keyword">this</span>, rest)
                        
                BoletoService.<span class="hljs-keyword">delete</span> = <span class="hljs-function"><span class="hljs-params">(form, pid)</span> -&gt;</span>
                        $q (resolve, reject) -&gt;
                                db = firebase.database()
<span class="hljs-function">                                <span class="hljs-title">_onBoletos</span> = <span class="hljs-params">(boletos)</span> -&gt;</span>
                                        _boletos = boletos.val()
                                        <span class="hljs-keyword">for</span> i,b <span class="hljs-keyword">of</span> _boletos
                                                _b = b.invoice.id <span class="hljs-keyword">is</span> pid
                                                _b = b.status <span class="hljs-keyword">is</span> <span class="hljs-string">'DRAFT'</span>
                                                <span class="hljs-keyword">if</span> _b
                                                        <span class="hljs-keyword">delete</span> _boletos[i]
                                                        <span class="hljs-keyword">break</span>
                                       
                                        db.ref(<span class="hljs-string">"boletos/"</span>).set(_boletos)
<span class="hljs-function">                                        
                                <span class="hljs-title">onDelete</span> = <span class="hljs-params">(status)</span> -&gt;</span> db.ref(<span class="hljs-string">"boletos/<span class="hljs-subst">#{form}</span>"</span>).<span class="hljs-literal">on</span>(<span class="hljs-string">'value'</span>,_onBoletos)
                                $http.<span class="hljs-keyword">delete</span>(<span class="hljs-string">"/paypal/invoices/<span class="hljs-subst">#{pid}</span>"</span>).<span class="hljs-keyword">then</span>(onDelete)
                                        
                                        
                <span class="hljs-keyword">return</span> BoletoService</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Retorne um conjunto contendo a definição do serviço </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        [<span class="hljs-string">'$http'</span>, <span class="hljs-string">'$q'</span>, <span class="hljs-string">'toastr'</span>, Service]</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
