#!/usr/bin/env /home/pi/.nvm/versions/node/v8.0.0/bin/node
var AppManager, ServerManager, atob, body_parser, chalk, compression, connect_assets, express, foreach, fs, getAuth, http, keytar, marked, morgan, node_uuid, onMsg, parseBasic, passport, passport_custom, passport_firebase_auth, path, pug, request_json;

fs = require('fs');

path = require('path');

http = require('http');

atob = require('atob');

body_parser = require('body-parser');

chalk = require('chalk');

compression = require('compression');

connect_assets = require('connect-assets');

express = require('express');

foreach = require('foreach');

keytar = require('keytar');

marked = require('marked');

morgan = require('morgan');

node_uuid = require('node-uuid');

passport = require('passport');

passport_custom = require('passport-custom');

passport_firebase_auth = require('passport-firebase-auth');

pug = require('pug');

request_json = require('request-json');


/* SETUP NODE_ENV */

process.env.NODE_ENV = process.env.NODE_ENV || 'development';

AppManager = (function() {
  function AppManager(app1) {
    this.app = app1;
    this.app.set('views', path.join(__dirname, '..', 'app/views/'));
    this.app.engine('pug', function(file_path, options, _callback) {
      return fs.readFile(file_path, 'utf8', function(err, content) {
        var fn;
        if (err) {
          _callback(err);
        }
        fn = pug.compile(content, {
          filename: file_path,
          doctype: 'html'
        });
        return _callback(null, fn({
          filters: [marked]
        }));
      });
    });
    this.app.set('view engine', 'pug');
    this.app.set('assets path', [path.join(__dirname, '..', 'app/assets/fonts'), path.join(__dirname, '..', 'app/assets/doc'), path.join(__dirname, '..', 'app/assets/img'), path.join(__dirname, '..', 'app/assets/css'), path.join(__dirname, '..', 'app/assets/js'), path.join(__dirname, '..', 'app/assets/')]);
    this.app.set('port', parseInt(process.env.PORT || '3000'));
  }

  return AppManager;

})();

AppManager.init = function(result) {
  return new Promise(function(resolve, reject) {
    var app, app_manager;
    app = express();
    app_manager = new AppManager(app);
    app_manager.passport();
    app_manager.boot();
    app_manager.index();
    app_manager.login();
    app_manager.config();
    app_manager.templates();
    app_manager.services();
    app_manager.typeform();
    app_manager.docs();
    return resolve(app);
  });
};

parseBasic = function(result) {
  return new Promise(function(resolve, reject) {
    var c, i, len, o, r;
    o = {};
    for (i = 0, len = result.length; i < len; i++) {
      r = result[i];
      c = r.split("=");
      o[c[0]] = c[1];
    }
    return resolve(o);
  });
};

getAuth = function(req) {
  return new Promise(function(resolve, reject) {
    return resolve(req.query['email']);
  });
};

AppManager.prototype.passport = function() {

  /* TODO */
};

passport.use('firebase-login', new passport_custom(function(req, done) {
  return firebase_admin.auth().getUser(req.query.uid).then(function(userRecord) {
    var user;
    user = userRecord.toJSON();
    console.log(user);
    if (user.accessToken === req.query.accessToken) {
      return done(null, userRecord.toJSON(), {
        message: "User " + user.uid + " logged"
      });
    } else {
      return done(true);
    }
  })["catch"](function(err) {
    return done(err.code, null, {
      message: err.message
    });
  });
}));

passport.serializeUser(function(user, done) {
  return done(null, user.uid);
});

passport.deserializeUser(function(id, done) {
  return done(id);
});

ServerManager = {};

ServerManager.make = function(app) {
  var self;
  self = this;
  return new Promise(function(resolve, reject) {
    var server;
    server = http.createServer(app);
    server.on('error', function(error) {
      var bind, fn;
      if (error.syscall === 'listen') {
        throw error;
      }
      bind = typeof port === 'string' ? 'Pipe ' + port : 'Port ' + port;
      fn = function(msg) {
        console.error(chalk.red(bind + ' ' + msg));
        return process.exit(1);
      };
      if (error.code === 'EACCES') {
        return fn('requires elevated privileges');
      } else if (error.code === 'EADDRINUSE') {
        return fn('is already in use');
      } else {
        return reject(error);
      }
    });
    server.listen(app.get('port'), 'localhost');
    return server.on('listening', function() {
      var addr;
      addr = server.address();
      return resolve(addr);
    });
  });
};

AppManager.prototype.boot = function() {
  this.app.use(morgan(':method :url :status Content-Lenght: :res[content-length] time: :response-time ms'));
  this.app.use(compression());
  this.app.use(body_parser.json());
  this.app.use(body_parser.urlencoded({
    extended: false
  }));
  this.app.use(connect_assets({
    paths: this.app.get('assets path')
  }));
  this.app.use(passport.initialize());
  return this.app.use(passport.session());
};

AppManager.prototype.index = function() {
  return this.app.get('/', function(req, res) {
    return res.render('index');
  });
};

AppManager.prototype.login = function() {
  return this.app.post('/auth/callback', function(req, res) {
    return passport.authenticate('firebase-login', function(err, user, info) {
      if (err) {
        return res.json(err);
      } else {
        return res.json({
          user: user,
          info: info
        });
      }
    })(req, res);
  });
};

AppManager.prototype.config = function() {
  return this.app.get('/config', function(req, res) {
    var projectName;
    projectName = require((path.join(__dirname)) + "/../package.json").firebase.project.name;
    return keytar.findPassword(projectName + ".firebase.apiKey").then(function(apiKey) {
      return keytar.findPassword(projectName + ".firebase.messagingSenderId").then(function(messagingSenderId) {
        return res.json({
          apiKey: apiKey,
          authDomain: projectName + ".firebaseapp.com",
          databaseURL: "https://" + projectName + ".firebaseio.com",
          projectId: projectName,
          storageBucket: projectName + ".appspot.com",
          messagingSenderId: messagingSenderId
        });
      });
    });
  });
};

AppManager.prototype.templates = function() {
  var getTemplate;
  getTemplate = function(p) {
    return new Promise(function(resolve, reject) {
      var _p;
      _p = path.resolve((path.join(__dirname)) + "/../app/views/" + p + ".pug");
      return fs.readFile(_p, 'utf8', function(err, content) {
        var e, error1, html, opt, result;
        if (!err) {
          try {
            opt = {
              filename: _p,
              doctype: 'html'
            };
            html = pug.compile(content, opt)();
            result = {
              template: html,
              route: (function() {
                var r;
                if (p.match(/_index/)) {
                  return "/";
                } else if (p.match(/^\w+_uuid_[a-z]+$/)) {
                  r = p.split("_");
                  return "/" + r[0] + "/:uuid/" + r[2];
                } else if (p.match(/^\w+_uuid_[a-z]+_\w+$/)) {
                  r = p.split("_");
                  return "/" + r[0] + "/:uuid/" + r[2] + "/:token";
                } else if (p.match(/\w+_novo/)) {
                  r = p.split("_");
                  return "/" + r[0] + "/novo";
                } else {
                  return "/" + p;
                }
              })()
            };
            return resolve(result);
          } catch (error1) {
            e = error1;
            return reject(e);
          }
        } else {
          return reject(err);
        }
      });
    });
  };
  return this.app.get('/templates', function(req, res) {
    var onErr, onSuccess, template;
    onSuccess = function(results) {
      return res.json(results);
    };
    onErr = function(err) {
      return res.json(err.message);
    };
    return Promise.all((function() {
      var i, len, ref, results1;
      ref = require("../package.json")['angular-templates'];
      results1 = [];
      for (i = 0, len = ref.length; i < len; i++) {
        template = ref[i];
        results1.push(getTemplate(template));
      }
      return results1;
    })()).then(onSuccess)["catch"](onErr);
  });
};

AppManager.prototype.services = function() {
  var _on, getTemplate;
  getTemplate = function(p) {
    return new Promise(function(resolve, reject) {
      var _p;
      _p = path.resolve((path.join(__dirname)) + "/../app/views/" + p + ".pug");
      return fs.readFile(_p, 'utf8', function(err, content) {
        var html;
        if (!err) {
          html = pug.compile(content, {
            filename: _p,
            doctype: 'html'
          })();
          return resolve({
            name: p,
            options: {
              restrict: 'AE',
              template: html,
              replace: true,
              transclude: true
            }
          });
        } else {
          return reject(err);
        }
      });
    });
  };
  _on = function(what) {
    var a, i, len, ref, w;
    a = [];
    ref = require("../package.json")["angular-" + what];
    for (i = 0, len = ref.length; i < len; i++) {
      w = ref[i];
      a.push(getTemplate(w));
    }
    return Promise.all(a);
  };
  this.app.get("/services", function(req, res) {
    var onErr, onSuccess;
    onSuccess = function(result) {
      return res.json(result);
    };
    onErr = function(err) {
      return res.json(err);
    };
    return _on('services').then(onSuccess)["catch"](onErr);
  });
  return this.app.get("/directives", function(req, res) {
    var onErr, onSuccess;
    onSuccess = function(result) {
      return res.json(result);
    };
    onErr = function(err) {
      return res.json(err);
    };
    return _on('directives').then(onSuccess)["catch"](onErr);
  });
};

AppManager.prototype.typeform = function() {
  return this.app.get('/typeform/data-api', function(req, res) {
    var projectName, pwd;
    projectName = require((path.join(__dirname)) + "/../package.json").firebase.project.name;
    pwd = projectName + ".typeform.apiKey";
    console.log("Search for  " + pwd);
    return keytar.findPassword(pwd).then(function(apiKey) {
      var _url, onGet;
      _url = "form/" + req.query.uuid + "?key=" + apiKey;
      _url += "&completed=" + req.query.completed;
      _url += "&limit=" + req.query.limit;
      onGet = function(err, _res, body) {
        if (err) {
          return res.json(err);
        } else {
          console.log(body);
          return res.json(body);
        }
      };
      return request_json.createClient('https://api.typeform.com/v1/').get(_url, onGet);
    })["catch"](function(err) {
      return res.json(err);
    });
  });
};

AppManager.prototype.docs = function() {
  var root;
  root = path.resolve((path.join(__dirname)) + "/../app/assets");
  this.app.get("/docs", function(req, res) {
    var _index;
    _index = "doc/app/assets/js/index.html";
    return res.sendFile(_index, {
      'root': root
    });
  });
  this.app.get("/docs/app", function(req, res) {
    var _index;
    _index = "doc/app/assets/js/app.html";
    return res.sendFile(_index, {
      'root': root
    });
  });
  this.app.get("/docs/config", function(req, res) {
    var _index;
    _index = "doc/app/assets/js/config.html";
    return res.sendFile(_index, {
      'root': root
    });
  });
  this.app.get("/docs/auth-ctrl", function(req, res) {
    var _index;
    _index = "doc/app/assets/js/auth-ctrl.html";
    return res.sendFile(_index, {
      'root': root
    });
  });
  this.app.get("/docs/run", function(req, res) {
    var _index;
    _index = "doc/app/assets/js/run.html";
    return res.sendFile(_index, {
      'root': root
    });
  });
  this.app.get("/docs/services", function(req, res) {
    var _index;
    _index = "doc/app/assets/js/services.html";
    return res.sendFile(_index, {
      'root': root
    });
  });
  return this.app.get("/docs/docco.css", function(req, res) {
    var _index;
    _index = "doc/app/assets/js/docco.css";
    return res.sendFile(_index, {
      'root': root
    });
  });
};

onMsg = function(addr) {
  return "===* Vanessador server ready *===\n* Express/Firebase Server\n* started at " + (Date.now()) + "\n* available in\n  " + addr.address + ":" + addr.port + "\n=================================";
};

AppManager.init().then(ServerManager.make).then(function(addr) {
  return console.log(chalk.cyan(onMsg(addr)));
})["catch"](function(e) {
  return console.log(e);
});
